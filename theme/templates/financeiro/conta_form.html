{% extends 'base.html' %}

{% block title %}
    {{ titulo|default:"Formulário" }} - AEQUITAS
{% endblock title %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4 text-white">{{ titulo }}</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{% url 'financeiro:index' %}" class="text-decoration-none">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'financeiro:conta_list' %}" class="text-decoration-none">Contas a Receber</a></li>
        <li class="breadcrumb-item active">{{ titulo }}</li>
    </ol>

    <div class="card shadow-lg bg-dark border-secondary text-white mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-file-invoice-dollar me-2"></i>
                Preencha os dados da conta
            </h5>
        </div>
        <div class="card-body p-4">
            <form method="post" novalidate>
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="row">
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.cliente.id_for_label }}" class="form-label">{{ form.cliente.label }}</label>
                                {{ form.cliente }}
                                {% if form.cliente.help_text %}
                                    <small class="form-text text-muted">{{ form.cliente.help_text }}</small>
                                {% endif %}
                                {% for error in form.cliente.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.descricao.id_for_label }}" class="form-label">{{ form.descricao.label }}</label>
                                {{ form.descricao }}
                                {% if form.descricao.help_text %}
                                    <small class="form-text text-muted">{{ form.descricao.help_text }}</small>
                                {% endif %}
                                {% for error in form.descricao.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.valor_total.id_for_label }}" class="form-label">{{ form.valor_total.label }}</label>
                                {{ form.valor_total }}
                                {% if form.valor_total.help_text %}
                                    <small class="form-text text-muted">{{ form.valor_total.help_text }}</small>
                                {% endif %}
                                {% for error in form.valor_total.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.numero_parcelas.id_for_label }}" class="form-label">{{ form.numero_parcelas.label }}</label>
                                {{ form.numero_parcelas }}
                                {% if form.numero_parcelas.help_text %}
                                    <small class="form-text text-muted">{{ form.numero_parcelas.help_text }}</small>
                                {% endif %}
                                {% for error in form.numero_parcelas.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.data_vencimento_primeira_parcela.id_for_label }}" class="form-label">{{ form.data_vencimento_primeira_parcela.label }}</label>
                            {{ form.data_vencimento_primeira_parcela }}
                             {% if form.data_vencimento_primeira_parcela.help_text %}
                                <small class="form-text text-muted">{{ form.data_vencimento_primeira_parcela.help_text }}</small>
                            {% endif %}
                            {% for error in form.data_vencimento_primeira_parcela.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.observacoes.id_for_label }}" class="form-label">{{ form.observacoes.label }}</label>
                            {{ form.observacoes }}
                            {% if form.observacoes.help_text %}
                                <small class="form-text text-muted">{{ form.observacoes.help_text }}</small>
                            {% endif %}
                            {% for error in form.observacoes.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card bg-dark-subtle border-secondary h-100">
                            <div class="card-body">
                                <h5 class="card-title text-white">
                                    <i class="fas fa-eye me-2"></i>
                                    Previsão
                                </h5>
                                <div id="info-parcelas" class="mt-3 text-white-50">
                                    Preencha o valor e o número de parcelas para ver a previsão.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4 border-secondary">

                <div class="d-flex justify-content-end align-items-center gap-3">
                    <a href="{% url 'financeiro:conta_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Salvar Conta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const valorTotalInput = document.getElementById('{{ form.valor_total.id_for_label }}');
    const numeroParcelasInput = document.getElementById('{{ form.numero_parcelas.id_for_label }}');
    const infoDiv = document.getElementById('info-parcelas');

    function atualizarPrevisao() {
        const valorTotal = parseFloat(valorTotalInput.value.replace(',', '.'));
        const numeroParcelas = parseInt(numeroParcelasInput.value);

        if (!isNaN(valorTotal) && valorTotal > 0 && !isNaN(numeroParcelas) && numeroParcelas > 0) {
            const valorParcela = valorTotal / numeroParcelas;
            
            const formatter = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });

            infoDiv.innerHTML = `
                <p class="mb-1"><strong>${numeroParcelas} parcela${numeroParcelas > 1 ? 's' : ''} de</strong></p>
                <h3 class="text-white">${formatter.format(valorParcela)}</h3>
            `;
        } else {
            infoDiv.innerHTML = '<p class="text-white-50">Preencha o valor e o número de parcelas para ver a previsão.</p>';
        }
    }

    valorTotalInput.addEventListener('input', atualizarPrevisao);
    numeroParcelasInput.addEventListener('input', atualizarPrevisao);
    
    // Executa uma vez no carregamento da página caso os campos já estejam preenchidos
    atualizarPrevisao();
});
</script>
{% endblock extra_js %}