{% extends 'base.html' %}
{% load static %}

{% block title %}Nova Conta a Receber - AEQUITAS{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-file-invoice-dollar"></i> Nova Conta a Receber
                    </h4>
                </div>
                <div class="card-body">
                    {% if form.errors %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong>Erro!</strong> Corrija os erros abaixo:
                            <ul class="mb-0 mt-2">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>{{ field }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endif %}

                    <form method="post" id="formConta">
                        {% csrf_token %}
                        
                        <!-- Cliente -->
                        <div class="mb-4">
                            <label for="{{ form.cliente.id_for_label }}" class="form-label fw-bold">
                                Cliente <span class="text-danger">*</span>
                            </label>
                            {{ form.cliente }}
                            <small class="form-text text-muted d-block mt-1">
                                Selecione o cliente responsável
                            </small>
                        </div>

                        <!-- Descrição da Conta -->
                        <div class="mb-4">
                            <label for="{{ form.descricao.id_for_label }}" class="form-label fw-bold">
                                Descrição da Conta <span class="text-danger">*</span>
                            </label>
                            {{ form.descricao }}
                            <small class="form-text text-muted d-block mt-1">
                                Descrição do serviço ou produto
                            </small>
                        </div>

                        <!-- Valor Total -->
                        <div class="mb-4">
                            <label for="{{ form.valor_total.id_for_label }}" class="form-label fw-bold">
                                Valor Total (R$) <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                {{ form.valor_total }}
                            </div>
                            <small class="form-text text-muted d-block mt-1">
                                Valor total em reais
                            </small>
                        </div>

                        <!-- Número de Parcelas -->
                        <div class="mb-4">
                            <label for="{{ form.numero_parcelas.id_for_label }}" class="form-label fw-bold">
                                Número de Parcelas <span class="text-danger">*</span>
                            </label>
                            {{ form.numero_parcelas }}
                            <small class="form-text text-muted d-block mt-1">
                                Quantidade de parcelas (1 a 120)
                            </small>
                            <div id="infoValorParcela" class="alert alert-info mt-2" style="display: none;">
                                <small>
                                    <i class="fas fa-info-circle"></i> 
                                    Valor por parcela: <strong id="valorParcela">R$ 0,00</strong>
                                </small>
                            </div>
                        </div>

                        <!-- Data de Vencimento da 1ª Parcela -->
                        <div class="mb-4">
                            <label for="{{ form.data_vencimento.id_for_label }}" class="form-label fw-bold">
                                Data de Vencimento da 1ª Parcela <span class="text-danger">*</span>
                            </label>
                            {{ form.data_vencimento }}
                            <small class="form-text text-muted d-block mt-1">
                                As demais parcelas vencerão mensalmente após esta data
                            </small>
                        </div>

                        <hr class="my-4">

                        <!-- Botões -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'lista_contas' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save"></i> Criar Conta
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Informações Adicionais -->
            <div class="card mt-3 border-info">
                <div class="card-body bg-light">
                    <h6 class="text-info mb-2">
                        <i class="fas fa-lightbulb"></i> Informações Importantes
                    </h6>
                    <ul class="mb-0 small">
                        <li>O sistema criará automaticamente todas as parcelas com datas de vencimento mensais</li>
                        <li>Cada parcela terá o mesmo valor (valor total dividido pelo número de parcelas)</li>
                        <li>Você poderá editar individualmente cada parcela após a criação</li>
                        <li>O status das parcelas será atualizado automaticamente conforme as datas de vencimento</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Calcula e exibe o valor de cada parcela
document.addEventListener('DOMContentLoaded', function() {
    const valorTotalInput = document.getElementById('{{ form.valor_total.id_for_label }}');
    const numeroParcelasInput = document.getElementById('{{ form.numero_parcelas.id_for_label }}');
    const infoDiv = document.getElementById('infoValorParcela');
    const valorParcelaSpan = document.getElementById('valorParcela');

    function calcularValorParcela() {
        const valorTotal = parseFloat(valorTotalInput.value) || 0;
        const numeroParcelas = parseInt(numeroParcelasInput.value) || 1;

        if (valorTotal > 0 && numeroParcelas > 0) {
            const valorParcela = valorTotal / numeroParcelas;
            valorParcelaSpan.textContent = 'R$ ' + valorParcela.toFixed(2).replace('.', ',');
            infoDiv.style.display = 'block';
        } else {
            infoDiv.style.display = 'none';
        }
    }

    // Adiciona eventos de input
    valorTotalInput.addEventListener('input', calcularValorParcela);
    numeroParcelasInput.addEventListener('input', calcularValorParcela);

    // Calcula ao carregar se já houver valores
    calcularValorParcela();

    // Validação antes de enviar
    document.getElementById('formConta').addEventListener('submit', function(e) {
        const valorTotal = parseFloat(valorTotalInput.value) || 0;
        const numeroParcelas = parseInt(numeroParcelasInput.value) || 0;

        if (valorTotal <= 0) {
            e.preventDefault();
            alert('Por favor, informe um valor total maior que zero.');
            valorTotalInput.focus();
            return false;
        }

        if (numeroParcelas < 1 || numeroParcelas > 120) {
            e.preventDefault();
            alert('O número de parcelas deve estar entre 1 e 120.');
            numeroParcelasInput.focus();
            return false;
        }
    });
});
</script>

<style>
/* Remove conflitos de sobreposição nos inputs */
.form-control {
    position: relative;
    z-index: 1;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    z-index: 2;
}

/* Estilo para inputs com grupo */
.input-group {
    position: relative;
}

.input-group-text {
    background-color: #e9ecef;
    border: 1px solid #ced4da;
}

/* Espaçamento consistente */
.mb-4 {
    margin-bottom: 1.5rem !important;
}

/* Alerta de info */
#infoValorParcela {
    padding: 0.75rem;
    margin-top: 0.5rem;
    border-left: 4px solid #0dcaf0;
}

/* Card shadow */
.card.shadow {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

/* Botões */
.btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
}

/* Required asterisk */
.text-danger {
    color: #dc3545 !important;
}

/* Select melhorado */
select.form-control {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
    padding-right: 2.5rem;
}

/* Input de data */
input[type="date"].form-control {
    cursor: pointer;
}

/* Mensagens de ajuda */
.form-text {
    font-size: 0.875rem;
    color: #6c757d;
}
</style>
{% endblock %}